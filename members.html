<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Data Anggota - Perpustakaan Digital</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { background-color: #f8f9fa; }
    .navbar { border-bottom: 3px solid #0d6efd; }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary px-3">
    <a class="navbar-brand" href="dashboard.html">üìö Perpustakaan Digital</a>
    <div class="ms-auto d-flex align-items-center">
      <span id="user-name" class="text-white me-3"></span>
      <a href="dashboard.html" class="btn btn-light btn-sm me-2">Dashboard</a>
      <button class="btn btn-danger btn-sm" id="logoutBtn">Logout</button>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex align-items-center gap-2">
        <a href="dashboard.html" class="btn btn-outline-secondary">‚¨ÖÔ∏è Kembali</a>
        <h3 class="m-0">üë• Data Anggota</h3>
      </div>
      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#memberModal" id="btnAdd">+ Tambah Anggota</button>
    </div>

    <!-- Tabel Data -->
    <table class="table table-bordered table-striped align-middle">
      <thead class="table-dark text-center">
        <tr>
          <th>ID</th>
          <th>Nama User</th>
          <th>Kode Anggota</th>
          <th>Alamat</th>
          <th>Telepon</th>
          <th>Tanggal Bergabung</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="member-table"></tbody>
    </table>
  </div>

  <!-- Modal Tambah/Edit -->
  <div class="modal fade" id="memberModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Tambah Anggota</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="memberForm">
            <input type="hidden" id="memberId">
            <div class="mb-3">
              <label>User</label>
              <select id="user_id" class="form-select" required></select>
            </div>
            <div class="mb-3">
              <label>Kode Anggota</label>
              <input type="text" id="member_code" class="form-control" maxlength="20" required>
            </div>
            <div class="mb-3">
              <label>Alamat</label>
              <textarea id="address" class="form-control" maxlength="200"></textarea>
            </div>
            <div class="mb-3">
              <label>Telepon</label>
              <input type="text" id="phone" class="form-control" maxlength="20">
            </div>
            <div class="mb-3">
              <label>Tanggal Bergabung</label>
              <input type="date" id="join_date" class="form-control" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button class="btn btn-primary" id="saveMemberBtn">Simpan</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // üîê Login sederhana
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) window.location.href = 'index.html';
    document.getElementById('user-name').textContent = user.fullname + ' (' + user.role + ')';
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('user');
      window.location.href = 'index.html';
    });

    const API_URL = 'http://localhost/perpustakaan/api.php/records';
    const table = document.getElementById('member-table');
    const modal = new bootstrap.Modal(document.getElementById('memberModal'));
    const form = document.getElementById('memberForm');
    const saveBtn = document.getElementById('saveMemberBtn');

    let users = [];

    // üß≠ Load dropdown users
    async function loadUsers() {
      const res = await fetch(`${API_URL}/users`);
      const data = await res.json();
      users = data.records;

      const select = document.getElementById('user_id');
      select.innerHTML = '';
      users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.id;
        opt.textContent = u.fullname + ' (' + u.username + ')';
        select.appendChild(opt);
      });
    }

    // üì• Load data anggota
    async function loadMembers() {
      table.innerHTML = '';
      const res = await fetch(`${API_URL}/members`);
      const data = await res.json();

      data.records.forEach(m => {
        const userName = users.find(u => u.id == m.user_id)?.fullname || '-';
        table.innerHTML += `
          <tr>
            <td>${m.id}</td>
            <td>${userName}</td>
            <td>${m.member_code}</td>
            <td>${m.address || '-'}</td>
            <td>${m.phone || '-'}</td>
            <td>${m.join_date}</td>
            <td class="text-center">
              <button class="btn btn-warning btn-sm me-1" onclick="editMember(${m.id})">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteMember(${m.id})">Hapus</button>
            </td>
          </tr>`;
      });
    }

    // ‚ûï Tambah anggota
    document.getElementById('btnAdd').addEventListener('click', () => {
      document.querySelector('.modal-title').textContent = 'Tambah Anggota';
      form.reset();
      document.getElementById('memberId').value = '';
      document.getElementById('join_date').valueAsDate = new Date();
    });

    // üíæ Simpan anggota
    saveBtn.addEventListener('click', async () => {
      const id = document.getElementById('memberId').value;
      const payload = {
        user_id: parseInt(form.user_id.value),
        member_code: form.member_code.value,
        address: form.address.value,
        phone: form.phone.value,
        join_date: form.join_date.value
      };

      if (id) {
        await fetch(`${API_URL}/members/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } else {
        await fetch(`${API_URL}/members`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      }
      modal.hide();
      loadMembers();
    });

    // ‚úèÔ∏è Edit anggota
    async function editMember(id) {
      const res = await fetch(`${API_URL}/members/${id}`);
      const m = await res.json();

      document.getElementById('memberId').value = m.id;
      document.getElementById('user_id').value = m.user_id;
      document.getElementById('member_code').value = m.member_code;
      document.getElementById('address').value = m.address;
      document.getElementById('phone').value = m.phone;
      document.getElementById('join_date').value = m.join_date;

      document.querySelector('.modal-title').textContent = 'Edit Anggota';
      modal.show();
    }

    // ‚ùå Hapus anggota
    async function deleteMember(id) {
      if (confirm('Yakin ingin menghapus data anggota ini?')) {
        await fetch(`${API_URL}/members/${id}`, { method: 'DELETE' });
        loadMembers();
      }
    }

    // üöÄ Inisialisasi awal
    (async () => {
      await loadUsers();
      await loadMembers();
    })();
  </script>
</body>
</html>
