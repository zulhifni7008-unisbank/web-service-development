<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Pengembalian Buku - Perpustakaan Digital</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { background-color: #f8f9fa; }
    .navbar { border-bottom: 3px solid #0d6efd; }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary px-3">
    <a class="navbar-brand" href="dashboard.html">ğŸ“š Perpustakaan Digital</a>
    <div class="ms-auto d-flex align-items-center">
      <span id="user-name" class="text-white me-3"></span>
      <a href="dashboard.html" class="btn btn-light btn-sm me-2">Dashboard</a>
      <button class="btn btn-danger btn-sm" id="logoutBtn">Logout</button>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex align-items-center gap-2">
        <a href="dashboard.html" class="btn btn-outline-secondary">â¬…ï¸ Kembali</a>
        <h3 class="m-0">ğŸ”„ Pengembalian Buku</h3>
      </div>
    </div>

    <table class="table table-bordered table-striped align-middle">
      <thead class="table-dark text-center">
        <tr>
          <th>ID Transaksi</th>
          <th>Anggota</th>
          <th>Buku Dipinjam</th>
          <th>Tanggal Pinjam</th>
          <th>Batas Kembali</th>
          <th>Status</th>
          <th>Denda (Rp)</th>
          <th>Keterangan</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="return-table"></tbody>
    </table>
  </div>

  <script>
    // Cek login
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) window.location.href = 'index.html';
    document.getElementById('user-name').textContent = user.fullname + ' (' + user.role + ')';
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('user');
      window.location.href = 'index.html';
    });

    const API_URL = 'http://localhost/perpustakaan/api.php/records';
    const table = document.getElementById('return-table');
    const DENDA_PER_HARI = 2000;

    let members = [];
    let books = [];

    async function loadMembers() {
      const res = await fetch(`${API_URL}/members`);
      members = (await res.json()).records;
    }

    async function loadBooks() {
      const res = await fetch(`${API_URL}/books`);
      books = (await res.json()).records;
    }

    function hitungDenda(tglBatas) {
      const batas = new Date(tglBatas);
      const sekarang = new Date();
      const diffTime = sekarang - batas;
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      return diffDays > 0 ? diffDays * DENDA_PER_HARI : 0;
    }

    async function loadReturns() {
      table.innerHTML = '';
      const penaltiesRes = await fetch(`${API_URL}/penalties`);
      const penalties = (await penaltiesRes.json()).records;

      for (const p of penalties) {
        const trxRes = await fetch(`${API_URL}/borrow_transactions/${p.transaction_id}`);
        const trx = await trxRes.json();

        const member = members.find(m => m.id === trx.member_id);
        const memberName = member ? member.member_code : 'â€”';

        // Ambil detail buku
        const detailRes = await fetch(`${API_URL}/borrow_details?filter=transaction_id,eq,${trx.id}`);
        const detailData = await detailRes.json();
        const listBuku = detailData.records.map(d => {
          const book = books.find(b => b.id === d.book_id);
          return book ? `${book.title} (${d.quantity})` : `Buku ID ${d.book_id}`;
        });

        const statusBadge =
          trx.status === 'dikembalikan' ? 'bg-success' :
          trx.status === 'terlambat' ? 'bg-danger' :
          'bg-warning';

        const denda = Number(p.fine_amount);
        const deskripsi = p.description || '-';

        table.innerHTML += `
          <tr>
            <td>${trx.id}</td>
            <td>${memberName}</td>
            <td>${listBuku.join('<br>')}</td>
            <td>${trx.borrow_date}</td>
            <td>${trx.return_date}</td>
            <td><span class="badge ${statusBadge}">${trx.status}</span></td>
            <td class="text-end">${denda.toLocaleString('id-ID')}</td>
            <td>${deskripsi}</td>
            <td class="text-center">
              ${
                trx.status !== 'dikembalikan'
                  ? `<button class="btn btn-success btn-sm" onclick="returnBook(${trx.id})">Kembalikan</button>`
                  : `<span class="text-muted">Selesai</span>`
              }
            </td>
          </tr>`;
      }
    }

    // Proses pengembalian buku
    async function returnBook(id) {
      if (!confirm(`Yakin ingin mengembalikan buku untuk transaksi #${id}?`)) return;

      const today = new Date().toISOString().split('T')[0];

      const trxRes = await fetch(`${API_URL}/borrow_transactions/${id}`);
      const trx = await trxRes.json();

      const batas = new Date(trx.return_date);
      const now = new Date();
      const terlambat = now > batas;
      const diffDays = Math.max(0, Math.floor((now - batas) / (1000 * 60 * 60 * 24)));
      const fine = terlambat ? diffDays * DENDA_PER_HARI : 0;

      // Update transaksi menjadi dikembalikan
      await fetch(`${API_URL}/borrow_transactions/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ...trx,
          status: 'dikembalikan',
          return_date: today
        })
      });

      // Update atau buat ulang record di penalties
      await fetch(`${API_URL}/penalties?filter=transaction_id,eq,${id}`)
        .then(res => res.json())
        .then(async data => {
          if (data.records.length > 0) {
            // Update existing penalty
            const pid = data.records[0].id;
            await fetch(`${API_URL}/penalties/${pid}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                transaction_id: id,
                fine_amount: fine,
                description: terlambat
                  ? `Terlambat ${diffDays} hari`
                  : 'Dikembalikan tepat waktu'
              })
            });
          } else {
            // Insert new penalty
            await fetch(`${API_URL}/penalties`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                transaction_id: id,
                fine_amount: fine,
                description: terlambat
                  ? `Terlambat ${diffDays} hari`
                  : 'Dikembalikan tepat waktu'
              })
            });
          }
        });

      alert(terlambat ? `Buku terlambat ${diffDays} hari, denda Rp ${fine}.` : 'Buku dikembalikan tepat waktu.');
      loadReturns();
    }

    (async () => {
      await loadMembers();
      await loadBooks();
      await loadReturns();
    })();
  </script>
</body>
</html>
